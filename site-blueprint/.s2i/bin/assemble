#!/bin/bash -e

function create_directory() {
    DIRECTORY=$1

    if [ ! -d ${DIRECTORY} ] ; then
        echo -ne "creating ${DIRECTORY} ... "
        mkdir -p ${DIRECTORY}
    fi
}

function install_plugins {
    pushd . &> /dev/null

    create_directory /tmp/src/plugins
    cd /tmp/src/plugins

    for PLUGIN in `cat ../plugins.cfg` ; do
        echo -ne "Install plugin '${PLUGIN}' ... downloading ... "
        curl -Ls https://downloads.wordpress.org/plugin/${PLUGIN}.zip > ${PLUGIN}.zip

        echo -ne "unpacking ... "
        unzip ${PLUGIN}.zip

        echo -ne "deleting ZIP-file ... "
        rm -f ${PLUGIN}.zip

        echo "done"
    done

    popd . &> /dev/null
}

function install_languages() {
    pushd . &> /dev/null

    create_directory /tmp/src/languages
    cd /tmp/src/languages

    for LANGUAGE_DEFINITION in `cat ../languages.cfg` ; do
        LANGUAGE="$(echo ${LANGUAGE_DEFINITION} | cut -d: -f1)"
        NAME="$(echo ${LANGUAGE_DEFINITION} | cut -d: -f2)"

        echo -ne "Installing language '${NAME}' ... download '${LANGUAGE}' ... saving '${NAME}.mo' ... "
        curl -Ls https://translate.wordpress.org/projects/wp/${LANGUAGE}/export-translations?format=mo > ${NAME}.mo
    
        echo "done"
    done

    popd &> /dev/null
}

function copy_user_content() {
    # Copy user provided plugins, themes, language files and configuration
    # files into the persistent volume. This happens every time the image is
    # started, which is not ideal. If application is scaled, then could also
    # occur from multple replicas at the same time. No obvious way to avoid
    # that, so outstanding question as to whether that will cause any issues.

    if [ -d /tmp/src/plugins ]; then
        cp -rf /tmp/src/plugins/* wp-content/plugins/ 2>/dev/null || true
    fi

    if [ -d /tmp/src/themes ]; then
        cp -rf /tmp/src/themes/* wp-content/themes/ 2>/dev/null || true
    fi

    if [ -d /tmp/src/languages ]; then
        cp -rf /tmp/src/languages/* wp-content/languages/ 2>/dev/null || true
    fi

    if [ -f /tmp/src/configs/wp-config.php ]; then
        cp -f /tmp/src/wp-config.php wp-config.php
        chmod 644 wp-config.php
    fi

    if [ -f /tmp/src/configs/.htaccess ]; then
        cp -f /tmp/src/.htaccess .htaccess
        chmod 604 .htaccess
    fi
}

function install_authors_notepad_theme() {
    pushd . &> /dev/null

    echo -ne "Installing author's notepad theme ... "

    create_directory /tmp/src/themes

    cd /tmp/src/themes

    echo -ne "downloading theme ... "
    curl -Ls https://www.lichti.de/authors-notepad.tar.gz > authors-notepad.tar.gz
    echo -ne "extracting ... "
    tar xzf authors-notepad.tar.gz
    rm -f authors-notepad.tar.gz

    echo "done"
    popd &> /dev/null
}


install_languages
install_plugins
install_authors_notepad_theme

copy_user_content
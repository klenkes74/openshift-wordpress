#!/bin/bash -xe


function copy_user_content() {
    # Copy user provided plugins, themes, language files and configuration
    # files into the persistent volume. This happens every time the image is
    # started, which is not ideal. If application is scaled, then could also
    # occur from multple replicas at the same time. No obvious way to avoid
    # that, so outstanding question as to whether that will cause any issues.

    if [ -d /tmp/src/plugins ]; then
        cp -rf /tmp/src/plugins/* wp-content/plugins/ 2>/dev/null || true
    fi

    if [ -d /tmp/src/themes ]; then
        echo -ne "Installing author's notepad theme ... "
        curl -Ls https://www.lichti.de/authors-notepad.tar.gz > /tmp/src/themes/authors-notepad.tar.gz
        pushd . &> /dev/null
        cd /tmp/src/themes
        tar xzf authors-notepad.tar.gz
        rm -y authors-notepad.tar.gz
        popd &> /dev/null
        echo "done"
                        
        cp -rf /tmp/src/themes/* wp-content/themes/ 2>/dev/null || true
    fi

    if [ -d /tmp/src/languages ]; then
        cp -rf /tmp/src/languages/* wp-content/languages/ 2>/dev/null || true
    fi

    if [ -f /tmp/src/configs/wp-config.php ]; then
        cp -f /tmp/src/wp-config.php wp-config.php
        chmod 644 wp-config.php
    fi

    if [ -f /tmp/src/configs/.htaccess ]; then
        cp -f /tmp/src/.htaccess .htaccess
        chmod 604 .htaccess
    fi
}


copy_user_content